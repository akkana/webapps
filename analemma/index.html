<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Analemma</title>
<style>
body { border: 0; margin: 0; padding: 0; }
</style>
<script language="javascript" type="text/javascript" src="js/suncalc.js"></script>
<script language="javascript">
 const TWOPI = Math.PI * 2.;
 const HALFPI = Math.PI / 2.;

 function drawCircle(ctx, xc, yc, r, fill) {
     ctx.beginPath();
     ctx.ellipse(xc, yc, r, r, 0, 0, TWOPI);
     if (fill)
         ctx.fill();
     else
         ctx.stroke();
 }

 function changeColor(ctx, c) {
     ctx.fillStyle = c;
     ctx.strokeStyle = c;
 }
</script>
</head>

<body>

  <canvas id="canvas" style="position: absolute; left:0px; top:0px ;width: 100%; height: 100%"></canvas>

<script language=JavaScript>
var backgroundImg;

function drawAnalemma() {
    // draw an analemma
    var canvas = document.getElementById('canvas');
    var canvasWidth = window.innerWidth;
    var canvasHeight = window.innerHeight;
    console.log("Width", canvasWidth, ", height", canvasHeight);

    var ctx = canvas.getContext('2d');
    ctx.canvas.width  = canvasWidth;
    ctx.canvas.height = canvasHeight;

    if (backgroundImg) {
        /*
        console.log("Initially, image is", backgroundImg.style.width,
                    "x", backgroundImg.style.height);
        console.log("natural height:", backgroundImg.naturalHeight,
                    "complete?", backgroundImg.complete);
        */

        // Specifying source and dest width and height in the drawImage call
        // is supposed to make the image scale, but it doesn't unless you
        // also set width and height in the image element's style:
        backgroundImg.style.width = ctx.canvas.width + "px";
        backgroundImg.style.height = ctx.canvas.height + "px";
        // console.log("Changed to", backgroundImg.style.width, "x",
        //             backgroundImg.style.height);

        ctx.drawImage(backgroundImg,
                      0, 0, backgroundImg.width, backgroundImg.height,
                      0, 0, ctx.canvas.width,    ctx.canvas.height);
    } else {
        changeColor(ctx, "000");
        ctx.fillRect(0, 0, canvasWidth, canvasHeight);
    }

    var lon = -106.306;
    var lat = 35.885;

    changeColor(ctx, "#ff0");

    // Get the standard time timezone offset (January)
    var year = 2021;
    var stdTZOffset = new Date(year, 0, 1, 12, 0).getTimezoneOffset();

    var days = [1, 10, 20];
    const radius = 4;
    for (month=0; month < 12; ++month) {
        for (dayindex=0; dayindex < days.length; ++dayindex) {
            var d = new Date(year, month, days[dayindex], 12, 0);
            var newTZOffset = d.getTimezoneOffset();
            if (newTZOffset != stdTZOffset) {
                var hroffset = parseInt((stdTZOffset - newTZOffset) / 60);
                var minoffset = (stdTZOffset - newTZOffset) % 60;
                d = new Date(year, month, days[dayindex],
                             12 + hroffset, minoffset);
            }
            var sunpos = SunCalc.getPosition(d, lat, lon);
            drawCircle(ctx,
                       sunpos.azimuth * canvasWidth / Math.PI + canvasWidth/2,
                       canvasHeight - sunpos.altitude * canvasHeight / HALFPI,
                       radius, true);
        }
    }
 }

 backgroundImg = new Image();

 backgroundImg.onload = function() {
     drawAnalemma();
 }
 backgroundImg.onerror = function() {
     backgroundImg = null;
     drawAnalemma();
 }

 backgroundImg.src = "background.jpg";

</script>

</body>
</html>
